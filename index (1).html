<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO CONFIGURATION -->
    <title>Zenthous Pro ERP | Professional GST Billing Suite</title>
    <meta name="description" content="Zenthous Pro ERP: The ultimate professional ecosystem for GST billing, inventory management, and business analytics.">
    
    <!-- PWA Config -->
    <meta name="theme-color" content="#4F46E5">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" id="pwa-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root { --primary: #4F46E5; --sidebar-bg: #0F172A; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; color: #1E293B; margin: 0; overflow-x: hidden; }

        /* Sidebar Navigation */
        #sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 45; display: none; backdrop-filter: blur(4px); }
        #sidebar-overlay.active { display: block; }
        .sidebar { width: 280px; height: 100vh; background: var(--sidebar-bg); color: white; position: fixed; left: 0; top: 0; z-index: 50; transition: transform 0.3s ease; }
        .main-content { margin-left: 280px; min-height: 100vh; transition: 0.3s ease; }
        @media (max-width: 1024px) { .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); } .main-content { margin-left: 0; } }

        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: #94A3B8; cursor: pointer; border-radius: 12px; margin: 4px 15px; transition: 0.3s; font-size: 14px; font-weight: 500; }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); }

        /* Dashboard UI */
        .premium-stat { border-radius: 28px; padding: 25px; transition: all 0.3s ease; border: 1px solid #E2E8F0; background: white; }
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 20px; }

        /* PREVIEW FIX FOR MOBILE */
        .preview-scroll-container { 
            width: 100%; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            background: #cbd5e1; 
            border-radius: 30px; 
            align-items: flex-start; 
        }
        #invoice-capture { 
            width: 210mm; 
            min-height: 297mm; 
            background: white; 
            position: relative; 
            flex-shrink: 0; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            padding: 15mm;
        }

        .input-field { width: 100%; padding: 12px 16px; border-radius: 14px; border: 1px solid #E2E8F0; background: #F9FAFB; outline: none; font-size: 14px; }
        .form-label { font-size: 10px; font-weight: 800; color: #64748B; text-transform: uppercase; margin-bottom: 6px; display: block; letter-spacing: 0.5px; }

        @media (max-width: 768px) {
            #invoice-capture { transform: scale(0.42); transform-origin: top center; margin-bottom: -150mm; }
            .preview-scroll-container { min-height: 600px; padding: 10px; }
            .billing-grid { grid-template-cols: 1fr !important; }
        }
    </style>
</head>
<body>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar">
        <div class="p-8 flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg overflow-hidden p-1">
                <img src="logo.png" class="w-full h-full object-contain" alt="App Logo">
            </div>
            <span class="text-xl font-extrabold tracking-tight italic">Zenthous<span class="text-indigo-400">Pro</span></span>
        </div>
        <nav>
            <div onclick="showPage('dashboard', this)" class="nav-item active"><i class="fas fa-chart-pie"></i> Dashboard</div>
            <div onclick="showPage('billing', this)" class="nav-item"><i class="fas fa-file-invoice-dollar"></i> Create Bill</div>
            <div onclick="showPage('history', this)" class="nav-item"><i class="fas fa-history"></i> Invoices History</div>
            <div onclick="showPage('products', this)" class="nav-item"><i class="fas fa-boxes-stacked"></i> Inventory</div>
            <div onclick="showPage('profile', this)" class="nav-item"><i class="fas fa-user-gear"></i> Account Settings</div>
            <div onclick="showPage('about', this)" class="nav-item"><i class="fas fa-info-circle"></i> About Us</div>
        </nav>
    </aside>

    <div class="main-content">
        <!-- TOPBAR -->
        <header class="h-20 bg-white/80 backdrop-blur-md border-b flex items-center justify-between px-6 lg:px-10 sticky top-0 z-40">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="lg:hidden w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center"><i class="fas fa-bars"></i></button>
                <h2 id="page-title" class="text-xs font-black text-slate-400 uppercase tracking-widest">Dashboard</h2>
            </div>
            <div class="flex items-center gap-4">
                <p id="top-biz-name" class="text-xs font-black text-slate-800 uppercase hidden sm:block">Business Name</p>
                <div id="top-logo-display" class="w-11 h-11 rounded-full bg-slate-100 border overflow-hidden flex items-center justify-center"></div>
            </div>
        </header>

        <div class="p-4 lg:p-10">

            <!-- PAGE: DASHBOARD -->
            <section id="page-dashboard" class="page-view space-y-8 text-left">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="premium-stat bg-indigo-600 text-white shadow-xl border-none"><p class="text-[10px] font-black opacity-70 uppercase tracking-widest">Total Paid</p><h2 id="total-revenue" class="text-2xl font-black mt-1">₹0</h2></div>
                    <div class="premium-stat"><p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Pending</p><h2 id="pending-revenue" class="text-2xl font-black mt-1 text-amber-500">₹0</h2></div>
                    <div class="premium-stat"><p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Stock Health</p><h2 id="total-stock-count" class="text-2xl font-black mt-1 text-slate-800">0</h2></div>
                    <div class="premium-stat"><p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Invoices</p><h2 id="total-bill-count" class="text-2xl font-black mt-1 text-slate-800">0</h2></div>
                </div>
                <div class="glass-card p-6 lg:p-10">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="font-black text-slate-800 text-xs uppercase tracking-widest">Revenue Analytics</h3>
                        <select id="graph-filter" onchange="initDashboard()" class="text-xs font-bold bg-slate-50 rounded-lg p-2 outline-none"><option value="7">7 Days</option><option value="30">30 Days</option></select>
                    </div>
                    <div class="h-[350px]"><canvas id="salesChart"></canvas></div>
                </div>
                <!-- RESTORED EXPORT SECTION -->
                <div class="glass-card p-8 bg-slate-900 text-white">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                        <div><label class="text-[9px] font-black text-slate-500 uppercase block mb-2">Preset Range</label><select id="report-preset" class="input-field !bg-slate-800 !border-slate-700 !text-white" onchange="setReportDates()"><option value="7">7 Days</option><option value="30">30 Days</option></select></div>
                        <div><input type="date" id="report-from" class="input-field !bg-slate-800 !border-slate-700 !text-white"></div>
                        <div><input type="date" id="report-to" class="input-field !bg-slate-800 !border-slate-700 !text-white"></div>
                        <button onclick="downloadReport()" class="bg-indigo-600 py-4 rounded-2xl font-black text-xs uppercase shadow-xl">Export CSV</button>
                    </div>
                </div>
            </section>

            <!-- PAGE: BILLING (UX UPGRADED) -->
            <section id="page-billing" class="page-view hidden">
                <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
                    <div class="xl:col-span-4 space-y-6 text-left">
                        <!-- Step 1: Config -->
                        <div class="glass-card p-6 space-y-4">
                            <h3 class="font-black text-[12px] uppercase text-indigo-600 tracking-widest flex items-center gap-2"><i class="fas fa-sliders"></i> 1. Document Config</h3>
                            <div class="grid grid-cols-5 gap-2">
                                <button onclick="setTemplate('1')" id="t-btn-1" class="h-10 bg-indigo-600 text-white rounded-xl text-[10px] font-black">T1</button>
                                <button onclick="setTemplate('2')" id="t-btn-2" class="h-10 bg-slate-100 rounded-xl text-[10px] font-black">T2</button>
                                <button onclick="setTemplate('3')" id="t-btn-3" class="h-10 bg-slate-100 rounded-xl text-[10px] font-black">T3</button>
                                <button onclick="setTemplate('4')" id="t-btn-4" class="h-10 bg-slate-100 rounded-xl text-[10px] font-black">T4</button>
                                <button onclick="setTemplate('5')" id="t-btn-5" class="h-10 bg-slate-100 rounded-xl text-[10px] font-black">T5</button>
                            </div>
                            <div>
                                <label class="form-label">Document Type</label>
                                <select id="bill-type" onchange="calculate()" class="input-field"><option value="GST INVOICE">GST INVOICE</option><option value="ESTIMATE">ESTIMATE</option></select>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="p-3 bg-slate-50 rounded-xl text-[9px] font-black text-slate-500 flex items-center justify-between uppercase"><span>Tax</span><input type="checkbox" id="tax-toggle" checked onchange="calculate()"></div>
                                <div class="p-3 bg-slate-50 rounded-xl text-[9px] font-black text-slate-500 flex items-center justify-between uppercase"><span>QR Code</span><input type="checkbox" id="qr-toggle" checked onchange="calculate()"></div>
                            </div>
                        </div>

                        <!-- Step 2: Customer Details -->
                        <div class="glass-card p-6 space-y-4">
                            <h3 class="font-black text-[12px] uppercase text-indigo-600 tracking-widest flex items-center gap-2"><i class="fas fa-user"></i> 2. Customer & Date</h3>
                            <div><label class="form-label">Billing Date</label><input type="date" id="inv-date-input" class="input-field" oninput="calculate()"></div>
                            <div><label class="form-label">Customer Name</label><input type="text" id="cliName" oninput="calculate()" placeholder="Enter Customer Name" class="input-field"></div>
                            <div><label class="form-label">Full Address</label><textarea id="cliAddr" oninput="calculate()" placeholder="Customer Address" class="input-field" rows="2"></textarea></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="form-label">Invoice #</label><input type="text" id="invNo" placeholder="e.g. 1001" class="input-field"></div>
                                <div><label class="form-label">Status</label><select id="bill-status" class="input-field" onchange="calculate()"><option value="Paid">Paid</option><option value="Pending">Pending</option></select></div>
                            </div>
                        </div>

                        <!-- Step 3: Items -->
                        <div class="glass-card p-6">
                            <div class="flex justify-between items-center mb-6"><h3 class="font-black text-[12px] uppercase text-indigo-600 tracking-widest"><i class="fas fa-list-check"></i> 3. Line Items</h3><button onclick="addBillItem()" class="text-indigo-600 font-black text-xs uppercase tracking-widest">+ Add Item</button></div>
                            <div id="bill-items-area" class="space-y-4"></div>
                        </div>

                        <!-- Step 4: Final Notes -->
                        <div class="glass-card p-6">
                            <h3 class="font-black text-[12px] uppercase text-indigo-600 tracking-widest mb-4"><i class="fas fa-comment-dots"></i> 4. Final Notes</h3>
                            <textarea id="bill-notes" oninput="calculate()" placeholder="Add terms or bank info here..." class="input-field" rows="2"></textarea>
                        </div>

                        <button onclick="processAndDownload()" class="w-full bg-slate-900 text-white py-5 rounded-[24px] font-black shadow-2xl active:scale-95 transition tracking-widest uppercase text-xs">GENERATE INVOICE</button>
                    </div>

                    <!-- PREVIEW -->
                    <div class="xl:col-span-8 preview-scroll-container">
                        <div id="invoice-capture" class="tpl-1">
                            <div class="flex justify-between border-b pb-8 mb-8">
                                <div class="flex items-center gap-5 text-left">
                                    <div id="inv-logo-display" class="w-20 h-20 bg-slate-50 border rounded-2xl flex items-center justify-center overflow-hidden shadow-sm"></div>
                                    <div class="space-y-1">
                                        <p class="text-[9px] font-black text-slate-400 uppercase italic tracking-widest">Billing From:</p>
                                        <h2 id="view-bizName" class="text-xl font-black uppercase text-slate-900 leading-tight">Zenthous Pro</h2>
                                        <p id="view-bizAddr" class="text-[9px] text-slate-500 w-72 leading-relaxed"></p>
                                        <p id="view-bizEmail" class="text-[9px] text-slate-500 font-bold"></p>
                                        <p id="view-bizGst" class="text-[9px] font-black text-indigo-600 uppercase tracking-widest">GST: --</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <h1 id="view-bill-title" class="text-4xl font-black text-indigo-600 tracking-tighter italic uppercase">GST INVOICE</h1>
                                    <h3 id="view-invNo" class="font-black text-lg mt-4">#1001</h3>
                                    <p id="view-date" class="font-black text-[10px] text-slate-400 uppercase tracking-widest">--/--/--</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-10 mb-8 text-left border-b pb-8">
                                <div><p class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Billed To:</p><h3 id="view-cliName" class="font-black text-slate-900 uppercase text-lg leading-tight">Customer Name</h3><p id="view-cliAddr" class="text-xs text-slate-400 mt-2 w-64 leading-relaxed whitespace-pre-line"></p></div>
                                <div class="text-right flex flex-col items-end">
                                    <div id="qr-block" class="hidden text-center border p-4 rounded-[28px] bg-white shadow-sm ring-8 ring-slate-50">
                                        <img id="qr-img" class="w-24 h-24 mx-auto">
                                        <p class="text-[8px] font-black text-indigo-600 mb-1 uppercase tracking-widest underline decoration-2">SCAN TO PAY</p>
                                        <p id="pending-label" class="text-[8px] text-red-500 font-black mt-2 uppercase tracking-tighter hidden">Payment Pending</p>
                                    </div>
                                    <span id="view-status-badge" class="status-paid mt-4">Paid</span>
                                </div>
                            </div>
                            <table class="w-full mb-8 overflow-hidden rounded-2xl text-left border">
                                <thead class="bg-slate-900 text-white text-[9px] font-black uppercase tracking-widest">
                                    <tr><th class="py-5 px-5 w-12 text-center">S.No</th><th class="py-5 px-5">Description</th><th class="py-5 text-center">Qty</th><th class="py-5 text-right">Price</th><th class="py-5 text-right tax-col">GST</th><th class="py-5 px-5 text-right font-black">Total</th></tr>
                                </thead>
                                <tbody id="view-table-body" class="text-[12px] border-b-2"></tbody>
                            </table>
                            
                            <div id="view-notes-area" class="hidden bg-slate-50 p-6 rounded-3xl border border-dashed border-slate-200 mb-8 text-left">
                                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Invoice Notes:</p>
                                <p id="view-notes" class="text-[10px] text-slate-600 italic whitespace-pre-line"></p>
                            </div>

                            <div class="flex justify-end pt-5"><div class="w-72 space-y-2"><div class="flex justify-between text-xs font-black text-slate-400 uppercase tracking-widest"><span>Subtotal</span><span id="view-subtotal">0.00</span></div><div id="tax-breakdown" class="space-y-1 py-1"></div><div class="flex justify-between items-center pt-4 border-t-2 border-slate-900 font-black text-slate-900 uppercase"><span>Grand Total</span><span id="view-grandtotal" class="text-3xl text-indigo-600 tracking-tighter">0.00</span></div></div></div>
                            <div class="absolute bottom-10 left-0 right-0 text-center text-[11px] font-extrabold text-indigo-600 uppercase tracking-[0.6em] opacity-80">Created by zenthous.in</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- HISTORY & INVENTORY -->
            <section id="page-history" class="page-view hidden"><div class="glass-card table-responsive"><table class="w-full text-left min-w-[800px]"><thead class="bg-slate-50 border-b text-[10px] font-black text-slate-400 uppercase tracking-widest"><tr><th class="px-8 py-6 text-center">Inv #</th><th class="px-8 py-6">Customer</th><th class="px-8 py-6 text-center">Amount</th><th class="px-8 py-6 text-center">Payment</th><th class="px-8 py-6 text-center">Date</th><th class="px-8 py-6 text-right">Actions</th></tr></thead><tbody id="history-list" class="divide-y divide-slate-50"></tbody></table></div></section>
            <section id="page-products" class="page-view hidden"><div class="glass-card table-responsive"><table class="w-full text-left min-w-[700px]"><thead class="bg-slate-50 border-b text-[10px] font-black text-slate-400 uppercase tracking-widest"><tr><th class="px-8 py-6 w-16 text-center">S.No</th><th class="px-8 py-6">Identity</th><th class="px-8 py-6 text-center">Price</th><th class="px-8 py-6 text-center">Stock</th><th class="px-8 py-6 text-center">Added On</th><th class="px-8 py-6 text-right">Operation</th></tr></thead><tbody id="inventory-list" class="divide-y divide-slate-50"></tbody></table></div></section>
            
            <!-- ABOUT US -->
            <section id="page-about" class="page-view hidden">
                <div class="max-w-4xl mx-auto glass-card p-10 lg:p-20 text-center space-y-10">
                    <h2 class="text-5xl font-black text-slate-800 tracking-tighter">Zenthous <span class="text-indigo-600">Pro</span></h2>
                    <div class="space-y-6 text-slate-600 leading-relaxed text-lg italic border-l-4 border-indigo-600 pl-6 bg-indigo-50/50 py-8 rounded-r-3xl text-left">
                        "Zenthous Pro ERP is an all-in-one professional billing ecosystem designed for modern entrepreneurs. Our platform integrates high-precision GST calculation, automated inventory tracking, and secure payment monitoring into a unified digital workspace. We believe in simplifying complex enterprise tasks to help you focus on scaling your business."
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                        <div class="p-6 bg-white border rounded-3xl"><h4 class="font-black text-xs uppercase mb-2 text-indigo-600">Our Vision</h4><p class="text-sm opacity-70">To become the backbone of small and medium business operations worldwide.</p></div>
                        <div class="p-6 bg-white border rounded-3xl"><h4 class="font-black text-xs uppercase mb-2 text-indigo-600">Engineering</h4><p class="text-sm opacity-70">Built with speed, accuracy, and responsive design for every device.</p></div>
                    </div>
                </div>
            </section>

            <!-- REMAINING PAGE: Profile -->
            <section id="page-profile" class="page-view hidden"><div class="max-w-4xl mx-auto glass-card p-10 space-y-10 text-left"><div class="flex flex-col sm:flex-row items-center gap-10 bg-slate-50 p-8 rounded-[40px]"><div id="settings-logo-display" class="w-32 h-32 bg-white border-2 border-dashed rounded-[30px] flex items-center justify-center overflow-hidden shadow-inner">Logo</div><input type="file" onchange="handleLogoUpload(event)" class="text-xs"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><input type="text" id="profName" placeholder="Business Name" class="input-field"><input type="text" id="profGst" placeholder="GSTIN" class="input-field"><input type="email" id="profEmail" placeholder="Official Email" class="input-field"><select id="profCurr" class="input-field"><option value="₹">₹ INR</option><option value="$">$ USD</option><option value="€">€ EUR</option></select><input type="text" id="profUpi" placeholder="UPI ID" class="input-field md:col-span-2"><textarea id="profAddr" placeholder="Physical Address" class="input-field md:col-span-2" rows="3"></textarea></div><button onclick="saveProfile(true)" class="w-full bg-slate-900 text-white py-5 rounded-[28px] font-black shadow-2xl transition">Save Branding</button></div></section>
        </div>
    </div>

    <!-- MODAL: PRODUCT -->
    <div id="productModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 text-left"><div class="bg-white w-full max-w-md rounded-[45px] p-10 shadow-2xl"><h3 id="modal-title" class="text-2xl font-black mb-8 uppercase tracking-tight text-slate-800">Product Entry</h3><div class="space-y-6"><input type="hidden" id="edit-prod-id"><input type="text" id="prodName" placeholder="Name" class="input-field"><div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] font-black text-slate-400 mb-2 block uppercase">Price</label><input type="number" id="prodPrice" class="input-field"></div><div><label class="text-[10px] font-black text-slate-400 mb-2 block uppercase">Stock</label><input type="number" id="prodStock" class="input-field"></div></div><div><label class="text-[10px] font-black text-slate-400 mb-2 block uppercase">Tax %</label><select id="prodGst" class="input-field"><option value="0">0%</option><option value="5">5%</option><option value="12">12%</option><option value="18" selected>18%</option><option value="28">28%</option></select></div><div class="flex gap-4 pt-6"><button onclick="closeProductModal()" class="flex-1 font-bold text-slate-400 uppercase text-xs">Discard</button><button onclick="saveProduct()" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-xl">Confirm</button></div></div></div></div>

    <script>
        let inventory = JSON.parse(localStorage.getItem('z_inv')) || [];
        let profile = JSON.parse(localStorage.getItem('z_prof')) || { currency: '₹' };
        let billHistory = JSON.parse(localStorage.getItem('z_history')) || [];
        let editingBillId = null;
        let charts = { sales: null };

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebar-overlay').classList.toggle('active'); }

        function showPage(id, el = null) {
            document.querySelectorAll('.page-view').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('page-' + id).classList.remove('hidden');
            if(el) el.classList.add('active');
            document.getElementById('page-title').innerText = id.toUpperCase();
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebar-overlay').classList.remove('active');
            loadUserBranding();
            if(id === 'dashboard') initDashboard();
            if(id === 'products') renderInventory();
            if(id === 'profile') loadProfile();
            if(id === 'history') renderHistory();
            if(id === 'billing') { if(!editingBillId) clearBillingForm(); calculate(); }
        }

        function loadUserBranding() {
            const clientLogo = localStorage.getItem('z_logo');
            const biz = profile.name || "Zenthous Pro";
            document.getElementById('top-biz-name').innerText = biz;
            document.getElementById('view-bizName').innerText = biz;
            document.getElementById('view-bizAddr').innerText = profile.addr || "";
            document.getElementById('view-bizEmail').innerText = profile.email || "";
            document.getElementById('view-bizGst').innerText = "GST: " + (profile.gst || "--");
            const logoHTML = clientLogo ? `<img src="${clientLogo}" class="w-full h-full object-contain">` : `<i class="fas fa-image text-slate-300"></i>`;
            [document.getElementById('top-logo-display'), document.getElementById('settings-logo-display'), document.getElementById('inv-logo-display')].forEach(area => { if(area) area.innerHTML = logoHTML; });
        }

        function calculate() {
            const taxOn = document.getElementById('tax-toggle').checked;
            const qrOn = document.getElementById('qr-toggle').checked;
            const cur = profile.currency || "₹";
            const tableBody = document.getElementById('view-table-body');
            const taxBody = document.getElementById('tax-breakdown');
            const status = document.getElementById('bill-status').value;
            tableBody.innerHTML = ''; taxBody.innerHTML = '';
            let sub = 0, tax = 0;

            document.querySelectorAll('.tax-col').forEach(el => el.style.display = taxOn ? 'table-cell' : 'none');
            document.getElementById('view-bill-title').innerText = document.getElementById('bill-type').value;

            document.querySelectorAll('#bill-items-area > div').forEach((row, i) => {
                const sel = row.querySelector('.item-select');
                if(!sel.value) return;
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const rate = parseFloat(row.querySelector('.item-price').value) || 0;
                const gst = taxOn ? (parseFloat(row.querySelector('.item-tax').value) || 0) : 0;
                const rowTotal = qty * rate; sub += rowTotal; tax += (rowTotal * gst) / 100;
                tableBody.innerHTML += `<tr class="border-b border-slate-50"><td class="py-4 px-5 text-slate-400 font-bold text-center">${i+1}</td><td class="px-5 font-black uppercase text-[10px] text-slate-800">${sel.options[sel.selectedIndex].text}</td><td class="text-center font-bold">${qty}</td><td class="text-right font-bold text-slate-500">${cur}${rate.toFixed(2)}</td><td class="text-right font-bold text-indigo-400 tax-col" style="display:${taxOn?'table-cell':'none'}">${gst}%</td><td class="py-4 px-5 font-black text-right text-slate-900">${cur}${(rowTotal + (rowTotal*gst/100)).toFixed(2)}</td></tr>`;
            });
            document.getElementById('view-subtotal').innerText = cur + sub.toFixed(2);
            document.getElementById('view-grandtotal').innerText = cur + (sub + tax).toFixed(2);
            if(taxOn && tax > 0) taxBody.innerHTML = `<div class="flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest"><span>TAX (GST)</span><span>${cur}${tax.toFixed(2)}</span></div>`;
            const rawDate = document.getElementById('inv-date-input').value;
            document.getElementById('view-date').innerText = rawDate ? new Date(rawDate).toLocaleDateString() : new Date().toLocaleDateString();
            document.getElementById('view-notes-area').classList.toggle('hidden', !document.getElementById('bill-notes').value);
            document.getElementById('view-notes').innerText = document.getElementById('bill-notes').value;

            if(qrOn && profile.upi && (sub+tax) > 0 && status === 'Pending') {
                document.getElementById('qr-block').classList.remove('hidden');
                document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=upi://pay?pa=${profile.upi}&pn=User&am=${(sub+tax).toFixed(2)}&cu=INR`;
            } else { document.getElementById('qr-block').classList.add('hidden'); }
            document.getElementById('view-cliName').innerText = document.getElementById('cliName').value || "Customer Name";
            document.getElementById('view-cliAddr').innerText = document.getElementById('cliAddr').value;
            document.getElementById('view-invNo').innerText = "#" + (document.getElementById('invNo').value || "1001");
            const badge = document.getElementById('view-status-badge');
            badge.innerText = status; badge.className = status === 'Paid' ? 'status-paid' : 'status-pending';
            document.getElementById('pending-label').classList.toggle('hidden', status === 'Paid');
        }

        function initDashboard() {
            const paid = billHistory.filter(h => h.status === 'Paid');
            const cur = profile.currency || "₹";
            document.getElementById('total-revenue').innerText = cur + paid.reduce((a, c) => a + c.amount, 0).toLocaleString();
            document.getElementById('pending-revenue').innerText = cur + billHistory.filter(h => h.status === 'Pending').reduce((a, c) => a + c.amount, 0).toLocaleString();
            document.getElementById('total-stock-count').innerText = inventory.reduce((a, c) => a + (parseInt(c.stock) || 0), 0);
            document.getElementById('total-bill-count').innerText = billHistory.length;
            const ctx = document.getElementById('salesChart').getContext('2d');
            if(charts.sales) charts.sales.destroy();
            const grad = ctx.createLinearGradient(0, 0, 0, 350); grad.addColorStop(0, 'rgba(79, 70, 229, 0.4)'); grad.addColorStop(1, 'rgba(79, 70, 229, 0)');
            charts.sales = new Chart(ctx, { type: 'line', data: { labels: paid.slice(-10).map(h => h.date), datasets: [{ data: paid.slice(-10).map(h => h.amount), borderColor: '#4F46E5', backgroundColor: grad, fill: true, tension: 0.4, borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { borderDash: [5, 5] }, ticks: { callback: v => cur + v } }, x: { grid: { display: false } } } } });
        }

        function processAndDownload() {
            const amount = parseFloat(document.getElementById('view-grandtotal').innerText.replace(/[^\d.]/g, ''));
            if(amount <= 0) return alert('Empty Bill');
            const items = Array.from(document.querySelectorAll('#bill-items-area > div')).map(row => ({ pId: row.querySelector('.item-db-id').value, qty: row.querySelector('.item-qty').value, price: row.querySelector('.item-price').value, tax: row.querySelector('.item-tax').value }));
            const bill = { id: editingBillId || Date.now(), customer: document.getElementById('cliName').value, address: document.getElementById('cliAddr').value, invNo: document.getElementById('invNo').value, amount: amount, status: document.getElementById('bill-status').value, date: document.getElementById('view-date').innerText, notes: document.getElementById('bill-notes').value, items };
            if(editingBillId) { const idx = billHistory.findIndex(b => b.id === editingBillId); billHistory[idx] = bill; }
            else { billHistory.push(bill); bill.items.forEach(it => { const i = inventory.findIndex(p => p.id == it.pId); if(i !== -1) inventory[i].stock -= it.qty; }); }
            localStorage.setItem('z_history', JSON.stringify(billHistory)); localStorage.setItem('z_inv', JSON.stringify(inventory));
            editingBillId = null;

            const element = document.getElementById('invoice-capture');
            html2pdf().set({ margin: 0, filename: `Inv_${bill.invNo}.pdf`, html2canvas: { scale: 4, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(element).save();
            showPage('dashboard');
        }

        function renderHistory() { const cur = profile.currency || "₹"; document.getElementById('history-list').innerHTML = billHistory.map(h => `<tr class="hover:bg-slate-50 transition"><td class="px-8 py-5 font-black text-slate-800 text-center">#${h.invNo}</td><td class="px-8 py-5 font-bold uppercase text-xs text-left">${h.customer}</td><td class="px-8 py-5 font-black text-center">${cur}${h.amount.toLocaleString()}</td><td class="px-8 py-5 text-center"><div class="flex flex-col items-center gap-1"><span class="${h.status==='Paid'?'status-paid':'status-pending'}">${h.status}</span><button onclick="toggleStatus(${h.id})" class="text-[8px] font-black text-indigo-500 uppercase border-b-2">Status</button></div></td><td class="px-8 py-5 text-center font-bold text-slate-400 text-xs">${h.date}</td><td class="px-8 py-5 text-right"><button class="text-indigo-600 font-bold" onclick="editBill(${h.id})">Edit</button></td></tr>`).reverse().join(''); }
        function renderInventory() { const c = profile.currency || "₹"; document.getElementById('inventory-list').innerHTML = inventory.map((p, i) => `<tr class="hover:bg-slate-50 transition"><td class="px-8 py-6 font-bold text-slate-400 text-center">${i+1}</td><td class="px-8 py-6 font-black uppercase text-slate-800 text-left">${p.name}</td><td class="px-8 py-6 text-center font-bold text-slate-500">${c}${p.price}</td><td class="px-8 py-6 text-center"><span class="${p.stock < 10 ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-600'} px-4 py-2 rounded-xl font-black text-xs">${p.stock} Units</span></td><td class="px-8 py-6 text-center text-xs font-bold text-slate-400">${p.dateAdded || 'N/A'}</td><td class="px-8 py-6 text-right"><button onclick="openProductModal(${p.id})" class="text-indigo-600 font-bold">Edit</button></td></tr>`).join(''); }
        function saveProduct() { const id = document.getElementById('edit-prod-id').value; const pData = { id: id ? parseInt(id) : Date.now(), name: document.getElementById('prodName').value, price: parseFloat(document.getElementById('prodPrice').value) || 0, stock: parseInt(document.getElementById('prodStock').value) || 0, gst: parseFloat(document.getElementById('prodGst').value), dateAdded: new Date().toLocaleDateString() }; if(id) { const idx = inventory.findIndex(x => x.id == id); inventory[idx] = pData; } else { inventory.push(pData); } localStorage.setItem('z_inv', JSON.stringify(inventory)); closeProductModal(); renderInventory(); }
        function toggleStatus(id) { const b = billHistory.find(x => x.id === id); b.status = b.status === 'Paid' ? 'Pending' : 'Paid'; localStorage.setItem('z_history', JSON.stringify(billHistory)); renderHistory(); initDashboard(); }
        function editBill(id) { const b = billHistory.find(x => x.id === id); editingBillId = id; showPage('billing'); document.getElementById('cliName').value = b.customer; document.getElementById('cliAddr').value = b.address; document.getElementById('invNo').value = b.invNo; document.getElementById('bill-status').value = b.status; document.getElementById('bill-notes').value = b.notes || ''; document.getElementById('inv-date-input').value = b.date.split('/').reverse().join('-'); document.getElementById('bill-items-area').innerHTML = ''; b.items.forEach(it => addBillItem(it)); }
        function openProductModal(id = null) { document.getElementById('productModal').classList.remove('hidden'); if(id) { const p = inventory.find(x => x.id === id); document.getElementById('edit-prod-id').value = p.id; document.getElementById('prodName').value = p.name; document.getElementById('prodPrice').value = p.price; document.getElementById('prodStock').value = p.stock; } else { document.getElementById('edit-prod-id').value = ''; document.getElementById('prodName').value = ''; document.getElementById('prodPrice').value = ''; document.getElementById('prodStock').value = '0'; } }
        function closeProductModal() { document.getElementById('productModal').classList.add('hidden'); }
        function loadProfile() { document.getElementById('profName').value = profile.name || ''; document.getElementById('profAddr').value = profile.addr || ''; document.getElementById('profGst').value = profile.gst || ''; document.getElementById('profEmail').value = profile.email || ''; document.getElementById('profUpi').value = profile.upi || ''; document.getElementById('profCurr').value = profile.currency || '₹'; loadUserBranding(); }
        function saveProfile(n) { profile = { name: document.getElementById('profName').value, addr: document.getElementById('profAddr').value, gst: document.getElementById('profGst').value, upi: document.getElementById('profUpi').value, email: document.getElementById('profEmail').value, currency: document.getElementById('profCurr').value }; localStorage.setItem('z_prof', JSON.stringify(profile)); if(n) alert('Saved!'); loadUserBranding(); }
        function handleLogoUpload(event) { const r = new FileReader(); r.onload = (e) => { localStorage.setItem('z_logo', e.target.result); loadUserBranding(); }; r.readAsDataURL(event.target.files[0]); }
        function addBillItem(data = null) { const id = Date.now() + Math.random(); const opts = inventory.map(p => `<option value="${p.id}" ${data && data.pId == p.id ? 'selected' : ''}>${p.name}</option>`).join(''); const html = `<div id="row-${id}" class="glass-card p-5 relative group border-slate-100"><button onclick="this.parentElement.remove(); calculate();" class="absolute -right-1 -top-1 w-6 h-6 bg-slate-900 text-white rounded-full text-[10px] opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button><select onchange="fillRow(this, ${id})" class="item-select input-field mb-3 font-black text-slate-700 uppercase text-xs"><option value="">-- Choose --</option>${opts}</select><div class="grid grid-cols-2 gap-3"><input type="number" class="item-qty input-field" value="${data ? data.qty : 1}" oninput="calculate()"/><input type="number" class="item-tax input-field" value="${data ? data.tax : 0}" readonly='readonly'/> <input type="hidden" class="item-price" value="${data ? data.price : 0}"/><input type="hidden" class="item-db-id" value="${data ? data.pId : ''}"/></div></div>`; document.getElementById('bill-items-area').insertAdjacentHTML('beforeend', html); if(data) calculate(); }
        function fillRow(sel, id) { const p = inventory.find(x => x.id == sel.value); if(p) { const r = document.getElementById('row-'+id); r.querySelector('.item-tax').value = p.gst; r.querySelector('.item-price').value = p.price; r.querySelector('.item-db-id').value = p.id; calculate(); } }
        function setTemplate(n) { document.getElementById('invoice-capture').className = `invoice-paper tpl-${n}`; for(let i=1; i<=5; i++) document.getElementById(`t-btn-${i}`).classList.toggle('bg-indigo-600', i==n); for(let i=1; i<=5; i++) document.getElementById(`t-btn-${i}`).classList.toggle('text-white', i==n); }
        function clearBillingForm() { editingBillId = null; document.getElementById('cliName').value = ''; document.getElementById('bill-notes').value = ''; document.getElementById('bill-items-area').innerHTML = ''; document.getElementById('invNo').value = billHistory.length + 1001; document.getElementById('inv-date-input').valueAsDate = new Date(); }
        function setReportDates() { const days = document.getElementById('report-preset').value; const end = new Date(); const start = new Date(); start.setDate(end.getDate() - days); document.getElementById('report-from').value = start.toISOString().split('T')[0]; document.getElementById('report-to').value = end.toISOString().split('T')[0]; }
        function downloadReport() { const cur = profile.currency || "₹"; let csv = 'Inv No,Customer,Amount,Status,Date\n'; billHistory.forEach(h => { csv += `${h.invNo},${h.customer},${h.amount},${h.status},${h.date}\n`; }); const blob = new Blob([csv], { type: 'text/csv' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'Report.csv'; a.click(); }

        window.onload = () => { showPage('dashboard'); };
    </script>
</body>
</html>